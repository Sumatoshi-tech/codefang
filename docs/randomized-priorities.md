# Randomized Treap Priorities â€” xorshift64 PRNG

The implicit treap timeline uses randomized priorities generated by an
xorshift64 PRNG instead of a monotonic counter. This ensures O(log N)
expected tree depth regardless of insertion order.

## Why Random Priorities Matter

A treap combines a BST (ordered by implicit position) with a heap
(ordered by priority). When priorities are random, the expected tree
depth is O(log N), giving O(log N) `splitByLines` and `merge` operations.

With the previous monotonic counter (`nextPriority++`), the most
recently created node always had the highest priority, causing it to
bubble to the root. This produced unbalanced structures depending on
insertion patterns, potentially degrading to O(N) depth.

## xorshift64 Algorithm

The PRNG uses Marsaglia's xorshift64 with three shift-XOR operations:

```
s ^= s << 13
s ^= s >> 7
s ^= s << 17
```

The upper 32 bits (`uint32(s >> 32)`) are returned as the priority
because they have better statistical properties than the lower bits
in xorshift generators.

Properties:
- Period: 2^64 - 1 (full period for any non-zero seed)
- Speed: 3 XOR + 3 shift operations (sub-nanosecond)
- No tables, no external state beyond a single `uint64`

## Seed

All treap timelines use the same deterministic seed constant
(`0x2545_F491_4F6C_DD1D`). Since each treap's PRNG diverges after
different operation sequences, the priority distributions are
effectively independent across files. The deterministic seed ensures
reproducible benchmark and test results.

## Performance

Benchmarks on AMD Ryzen AI 9 HX 370:

| Metric | Value | Notes |
|---|---|---|
| `Replace` latency | ~356 ns/op | After pool warmup, with random priorities |
| `Replace` allocs | 2 allocs/op | Node allocs from pool (0 heap); remaining 2 from `DeltaReport` slice |
| Tree depth (10K inserts) | < 42 | 3 * log2(10000) = 39.9 |

## Integration Points

| Component | Change |
|---|---|
| `treapTimeline.prngState` | Replaces `nextPriority uint32` |
| `newNode` | Calls `xorshift64(&tt.prngState)` for priority |
| `cloneDeepNode` | Calls `xorshift64(&tt.prngState)` for cloned node priority |
| `shallowCopy` | Copies `prngState` |
| `CloneDeep` | Copies `prngState` to clone |
| `maxDepth()` | New helper for testing tree balance |

## Design Decisions

1. **xorshift64 over `math/rand`**: Zero allocation overhead, no
   interface calls, deterministic without explicit seeding ceremony.
   The treap does not require cryptographic randomness.

2. **Upper bits extraction**: `uint32(state >> 32)` provides better
   distribution than `uint32(state)` for xorshift generators.

3. **Deterministic constant seed**: All treaps start with the same
   seed. This is correct because each treap accumulates different
   operations, causing PRNG state to diverge naturally.

4. **`maxDepth()` helper**: Recursive depth measurement kept on the
   type (not exported) for test access to private tree structure.
